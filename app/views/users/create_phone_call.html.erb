<div class="call-container">
  <div id="dialing_div" class="details">
    <%= image_tag(@lawyer.photo.url(:thumb), class: "userpic") %>
    <div class="info">
      <h2><%= @lawyer.full_name %></h2>
      <p>Connecting...</p>
      <p>You'll get a call in a minute.</p>
      <p>The first <%= @lawyer.free_consultation_duration %> minutes of the call will be free. </p>
      <p>Thereafter, you'll be billed at <%= number_to_currency @lawyer.rate + AppParameter.service_charge_value %>/min.</p>
      <input type='button' value="End call" onclick="hangupCall('<%= 0 %>');return false;" class="button gray" />
    </div>
  </div>

  <div id="connected_free_time_div" class="details">
    <%= image_tag(@lawyer.photo.url(:thumb), class: "userpic") %>
    <div class="info">
      <h2><%= @lawyer.full_name %></h2>
      <p id="call_status_span" class="strong">Call connected</p>
      <p id="free_text_span">Free time remaining: <span id="time_span">5:00</span>.</p>
      <p>Rate: <%= number_to_currency @lawyer.rate + AppParameter.service_charge_value %>/min.</p>
      <p>Billed time: <span id="billed_time_span">0 minutes</span>.</p>
      <input type='button' value="End call" onclick="hangupCall('<% @call.sid %>');return false;" class="button gray" />
    </div>
  </div>
</div>


<%= javascript_tag do %>
  var callStatusTimer = $.timer(function() {
      $.ajax({
        url: "/CheckCallStatus",
        type:'post',
        data:{call_id: '<%= @call.sid %>'},
        success: function(response){
          }
      });
    });
  count = '<%= 60*@lawyer.free_consultation_duration %>';
  var freeCallTimer = $.timer(function() {
    --count;
    if(count <= 0)
    {
      freeCallTimer.pause();
      $.ajax({
        url: "/UpdateCallStatus",
        type:'post',
        data:{call_id: '<%= @call.sid %>', sb:'1'},
        success: function(response){
          }
      });
    }
    else
    {
      seconds = count%60;
      seconds_string = (seconds.toString().length >1) ? seconds.toString() : '0' + seconds.toString();
      minutes = parseInt(count/60);
      timeString = minutes.toString() + ':' + seconds_string;
      $('#time_span').html(timeString);
    }
  });

    billingCounter = 0;
    var billingCallTimer = $.timer(function() {
      ++billingCounter;
      seconds = billingCounter%60;
      minutes = parseInt(billingCounter/60);
      minutes = (seconds == 0) ? minutes : minutes+1;
      timeString = minutes.toString() + " minute(s)";
      $('#billed_time_span').html(timeString);
    });

  $(document).ready(function(){
        $('#connected_free_time_div').hide();
        callStatusTimer.set({ time : 1000, autostart : true });
        freeCallTimer.set({ time : 1000, autostart : false });
        billingCallTimer.set({ time : 1000, autostart : false });
      });

  function hangupCall(call_sid)
  {
    $.ajax({
        url: "/twilio/endcall",
        type:'get',
        data:{call_id: '<%= @call.sid %>'},
        success: function(response){
        }
    });
  }
<% end %>

