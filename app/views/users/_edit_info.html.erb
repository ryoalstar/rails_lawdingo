<%=raw flash[:error] %>

<% errors = @user.errors %>
<%= form_for @user, :url =>@user.new_record? ? users_path : user_path(@user), :html=>{:multipart => true} do |f| %>
<% unless flash[:error] %>
  <% if errors.size > 0 %>
    <div class="error_explanation">
      <h4 class="error">Please fix the following errors:</h4>
      <ul class="errors">
        <% errors.full_messages.each do |error| %>
          <li><%= error %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
<% end %>

  <%= hidden_field_tag :user_type, @user[:user_type] %>
  <%= f.text_field :first_name ,{:placeholder=>"First Name",:class=>"name"} %>
  <%= f.text_field :last_name ,{:placeholder=>"Last Name",:class=>"name"} %>
  <%= f.text_field :email,{:placeholder=>"Email Address",:class=>"email"} %><br/>
  <%= f.password_field :password ,{:placeholder=>"Password",:class=>"passw"} %><br/>

    <% if @user.is_lawyer?
      bms = @user.corresponding_user.bar_memberships
      bms_text = "Bar Memberships: "
      bms.each{|bm|
       bms_text += "#{bm.state.name}(Bar ID: #{bm.bar_id}), "
      }
      bms_text.chomp!(', ')
      pas = @user.practice_areas
      ppas = @user.corresponding_user.practice_areas.parent_practice_areas
      pas_text = "Practice Areas: "
      ppas.each{|pa|
        pas_text += "#{pa.name}"
        sps = pa.specialities
        sps_text = ""
        sps.each{|sp|
          sps_text += pas.include?(sp)? "#{sp.name}, ": ""
        }
        sps_text.chomp!(', ')
        pas_text += (sps_text != '')? "(#{sps_text})":""
        pas_text += ', '
      }
      pas_text.chomp!(", ")
    %>
    <div id="div_states_barids" style="font-size:1em;"><%= bms_text %></div>
      <a href="#bar_membership" id="barids_editor" class="dialog-opener">(edit)</a>
      <div id="div_practice_areas" style="font-size:1em;"><%= pas_text %></div>
      <a href="#practices" id="practice_areas_editor" class="dialog-opener">(edit)</a>
    <% @user.rate = nil if @user.new_record? %>
    <%= f.text_field :rate ,{:class=>"paypal", :placeholder => "Per minute rate"} %><br/>
    <%= f.text_field :payment_email ,{:placeholder=>"Paypal email (for payments)",:class=>"paypal"} %><br/>
    <%= f.text_area :personal_tagline ,{:placeholder=>"Professional summary (100 chars)", :class=>"summary",:maxlength => 100, :rows=>2} %>
    <div style="font-size:14px;">Upload a photo</div>
    <%= f.file_field :photo %>
    <!--div class="f_label"></div><span style="font-size:12px;">to receive payments from Lawdingo</span><br/-->
 <% i = 0 %>
 <div id="dialog-overlay"></div>
 <div id="bar_membership" class="dialog-window">
   <h3>Select your bar membership(s)</h3>
   <div>
     <ul id="leveled_list_bar_ids" class="leveled-list">
       <%= f.fields_for :bar_memberships do |bar_membership_fields| %>
         <% if bar_membership_fields.object.new_record? %>
           <li id="<%= i %>">
             <%= check_box_tag("states_#{i}", @states[i].id, false, :id => "state_#{i}", :onchange =>"javascript:select_unselect_state('#{i}');")%><%=@states[i].name%>
             <%= bar_membership_fields.hidden_field :state_id %>
             <div class="sub" id="<%= @states[i].name %>"><%= "#{@states[i].abbreviation} Bar ID:" %>
               <%= bar_membership_fields.text_field :bar_id %>
             </div>
           </li>
           <% i += 1 %>
         <% end %>
       <% end %>
       <% j = 0 %>
       <%= f.fields_for :bar_memberships do |bar_membership_fields| %>
         <% unless bar_membership_fields.object.new_record? %>
         <li id="<%= i + j %>">
           <%= check_box_tag("states_#{i + j}", @filled_states[j].id, true, :id => "state_#{i+j}", :onchange =>"javascript:select_unselect_state('#{i+j}');")%><%=@filled_states[j].name%>
           <%= bar_membership_fields.hidden_field :state_id %>
           <div class="sub" id="<%= @filled_states[j].name %>"><%= "#{@filled_states[j].abbreviation} Bar ID:" %>
             <%= bar_membership_fields.text_field :bar_id %>
           </div>
         </li>
         <% j += 1 %>
         <% end %>
       <% end %>
     </ul>
   </div>
   <a class="button blue" onclick="setBarIds();">Done</a>
 </div>
 <div id="practices" class="dialog-window">
    <h3>Edit Practice Area(s)</h3>
    <div>
      <ul id="leveled-list_practice_areas" class="leveled-list">
          <% l_pas = @user.practice_areas
             PracticeArea.parent_practice_areas.each do |p| %>
          <li>
              <% if l_pas.include?(p) %>
              <input type="checkbox" id="<%= p.name %>" name="practice_areas[]" value="<%= p.id %>" checked/><%= p.name %>
              <% else %>
                <input type="checkbox" id="<%= p.name %>" name="practice_areas[]" value="<%= p.id %>" /><%= p.name %>
              <% end %>
              <div class="sub">
                  <%= p.name %> specialities:
                  <ul>
                    <% p.specialities.each do |s| %>
                      <% if l_pas.include?(s) %>
                      <li><input type="checkbox" id="<%= s.name %>" name="practice_areas[]" value="<%= s.id %>" checked/><%= s.name %></li>
                      <% else %>
                      <li><input type="checkbox" id="<%= s.name %>" name="practice_areas[]"  value="<%= s.id %>"/><%= s.name %></li>
                      <% end %>
                    <% end %>
                  </ul>
              </div>
          </li>
          <% end %>
      </ul>
    </div>
    <a class="button blue" onclick="setPracticeAreas();">Done</a>
</div>
<% end %>
  <%= f.submit @user.is_lawyer? ? (@user.new_record? ? 'Apply as Lawyer' : 'Update Account') : (@user.new_record? ? 'Join Lawdingo' : 'Update Account')  ,:class=>"button" %>
<% end %>

